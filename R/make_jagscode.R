#' Make JAGS code for Multiple Change Point model
#'
#' @param data data.frame or tibble containing the variables expressed in
#'   \code{segments} in long format.
#' @param prior Named list with parameter names as names and a JAGS distribution
#'   as value, e.g., \code{list(int_1 = "dunif(10, 30)")}.
#' @param formula_jags String. The formula for computing param_y given param_x
#'   and all predictors. Returned by \code{unpack_segments()}
#' @param param_x string
#' @param param_y String
#'
make_jagscode = function(data, prior, formula_jags, nsegments, sample, param_x, param_y) {
  # Transform priors from SD to precision
  for(i in 1:length(prior)) {
    if(stringr::str_detect(prior[[i]], "dnorm|dt|dcauchy|ddexp|dlogis|dlnorm")) {
      prior[[i]] = sd_to_prec(prior[[i]])
    }
  }

  # Begin model. `mm` is short for "mcp model".
  # Add fixed variables.
  mm = paste0("
  data {
    # X values
    MINX = ", ifelse(sample, min(data[, param_x]), "[requires data]"), "
    MAXX = ", ifelse(sample, max(data[, param_x]), "[requires data]"), "
    MEANX = ", ifelse(sample, mean(unlist(data[, param_x])), "[requires data]"), "
    SDX = ", ifelse(sample, sd(unlist(data[, param_x])), "[requires data]"), "

    # Y values
    MINY = ", ifelse(sample, min(data[, param_y]), "[requires data]"), "
    MAXY = ", ifelse(sample, max(data[, param_y]), "[requires data]"), "
    MEANY = ", ifelse(sample, mean(unlist(data[, param_y])), "[requires data]"), "
    SDY = ", ifelse(sample, sd(unlist(data[, param_y])), "[requires data]"), "
  }

  model {
    # Priors
    ")

  # Add all priors
  prior_vector = unlist(prior)
  prior_str = paste0(names(prior_vector), " ~ ", prior_vector, collapse="\n    ")
  mm = paste0(mm, prior_str)
  mm = paste0(mm, "
    cp_0 = -10^100  # mcp helper value; minus infinity
    cp_", nsegments, " = 10^100  # mcp helper value; plus infinity\n
    ")


  # * Build list of parameters involved in each segment
  mm = paste0(mm, "\n
  # Model and likelihood
  for(i_ in 1:length(", param_x, ")) {

    # Fitted value
    y_[i_] = \n")

  # Add JAGS code from `unpack_segments` and indent it
  mm = paste0(mm, gsub("\n", "\n      ", formula_jags))

  # Finally the likelihood
  mm = paste0(mm, "\n\n      # Likelihood
      ", param_y, "[i_] ~ dnorm(y_[i_], 1 / sigma^2)")

  # Log-density.
  mm = paste0(mm, "\n\n      # Log-density for LOO/WAIC computation
      loglik_[i_] = logdensity.norm(", param_y, "[i_], y_[i_], 1 / sigma^2)")

  # Finish up
  mm = paste0(mm, "
    }
  }")

  # Return the model
  mm
}
