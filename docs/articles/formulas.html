<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>About mcp formulas and models • mcp</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.3.7/cerulean/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha256-U5ZEeKfGNOja007MMD3YBI0A3OSZOQbeG6z2f2Y0hu8=" crossorigin="anonymous"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.1/css/all.min.css" integrity="sha256-nAmazAk6vS34Xqo0BSrTb+abbtFlgsFK7NKSi6o7Y78=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.1/css/v4-shims.min.css" integrity="sha256-6qHlizsOWFskGlwVOKuns+D1nB6ssZrHQrNj1wGplHc=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/headroom.min.js" integrity="sha256-DJFC1kqIhelURkuza0AvYal5RxMtpzLjFhsnVIeuk+U=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><link href="../extra.css" rel="stylesheet">
<meta property="og:title" content="About mcp formulas and models">
<meta property="og:description" content="">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-1026978-3"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-1026978-3');
</script>
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">mcp</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.1</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/binomial.html">Binomial change point analysis with mcp</a>
    </li>
    <li>
      <a href="../articles/formulas.html">About mcp formulas and models</a>
    </li>
    <li>
      <a href="../articles/poisson.html">Poisson change point analysis with mcp</a>
    </li>
    <li>
      <a href="../articles/priors.html">Working with priors in mcp</a>
    </li>
    <li>
      <a href="../articles/varying.html">Varying change points with mcp</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>About mcp formulas and models</h1>
                        <h4 class="author">Jonas Kristoffer Lindeløv</h4>
            
            <h4 class="date">2019-11-06</h4>
      
      
      <div class="hidden name"><code>formulas.Rmd</code></div>

    </div>

    
    
<p><code>mcp</code> takes a list of formulas, and defines the change point as the point on the x-axis where the data shifts from being generated by one formula to the next. So with <code>N</code> formulas, you have <code>N - 1</code> change points. A list with just one formula thus correspond to normal regression with 0 change points.</p>
<p>The formulas are called “segments” because they divide the (observed) x-axis into <code>N</code> segments. # Formula format for segments The format of each segment is generally <code>response ~ changepoint ~ linear_predictors</code>, except for the first segment where there is no change point (<code>response ~ linear_predictors</code>).</p>
<ul>
<li>
<strong>The response</strong> is just the name of a column in your data.</li>
<li>
<strong>The change point</strong> can be <code>1</code> for a population-level change point or <code>1 + (1|group)</code> <a href="articles/varying.html">varying change points</a> sampled around the population-level change point.</li>
<li>
<strong>The linear predictors</strong> can be <code>0</code> (no change in intercept), <code>1</code> (change in intercept), and any column in your data which you want to model a slope on.</li>
</ul>
<p>For convenience, you can omit the response and the change point in segment 2+, in which case the former response and an intercept-only (as opposed to random/varying) change point is assumed. When you call <code><a href="../reference/summary.mcpfit.html">summary(fit)</a></code>, it will show the explicit representation. Let us see this in action for this model where we predict <code>score</code> as a function of <code>time</code> in three segments, i.e., with two change points:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" title="1"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(mcp)</a>
<a class="sourceLine" id="cb1-2" title="2">segments =<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>(</a>
<a class="sourceLine" id="cb1-3" title="3">  score <span class="op">~</span><span class="st"> </span><span class="dv">1</span>,  <span class="co"># intercept</span></a>
<a class="sourceLine" id="cb1-4" title="4">  score <span class="op">~</span><span class="st"> </span><span class="dv">1</span> <span class="op">~</span><span class="st"> </span><span class="dv">0</span> <span class="op">+</span><span class="st"> </span>time,  <span class="co"># joined slope</span></a>
<a class="sourceLine" id="cb1-5" title="5">  <span class="op">~</span><span class="st"> </span>time  <span class="co"># disjoined slope. The intercept is implicit when not 0 + x.</span></a>
<a class="sourceLine" id="cb1-6" title="6">)</a>
<a class="sourceLine" id="cb1-7" title="7"></a>
<a class="sourceLine" id="cb1-8" title="8"><span class="co"># Interpret, but do not sample.</span></a>
<a class="sourceLine" id="cb1-9" title="9">fit =<span class="st"> </span><span class="kw"><a href="../reference/mcp.html">mcp</a></span>(segments, <span class="dt">sample =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb1-10" title="10"><span class="kw"><a href="../reference/summary.mcpfit.html">summary</a></span>(fit)</a></code></pre></div>
<pre><code>## Family: gaussian(link = 'identity')
## Segments:
##    score ~ 1 
##    score ~ 1 ~ 0 + time 
##    score ~ 1 ~ time 
## 
## No samples. Nothing to summarise.</code></pre>
<p>Notice how it added the response and the change point to the last segment?</p>
<p><code>mcp</code> is heavily inspired by <code>brms</code> which again is inspired by <a href="https://cran.r-project.org/web/packages/lme4/index.html"><code><a href="https://rdrr.io/pkg/lme4/man/lmer.html">lme4::lmer</a></code></a>. <a href="https://twitter.com/jonaslindeloev/status/1117760777249853440">Here is a bit of history</a> on that.</p>
<div id="parameter-names" class="section level1">
<h1 class="hasAnchor">
<a href="#parameter-names" class="anchor"></a>Parameter names</h1>
<p><code>mcp</code> automatically assigns names to the parameters in the format <code>type_i</code> where <code>i</code> is the segment number. Specifically:</p>
<ul>
<li>
<code>int_i</code> is the intercept in the ith segment.</li>
<li>
<code>year_i</code> is the slope in on the data column <code>year</code> in the ith segment. <code>x_i</code> is the slope on the data column <code>x</code> in the ith segment. The slope takes name after the data it is regressed on.</li>
<li>
<code>cp_i</code> is the ith change point. Notice that <code>cp_i</code> is specified in segment <code>i + 1</code>. <code>cp_1</code> occurs when there are two segments, and <code>cp_2</code> when there are three segments, etc. <em>OBS: future versions may start at cp_2.</em>.</li>
<li>
<code>cp_i_group</code> is the varying <em>deviations</em> from <code>cp_i</code>. See <a href="articles/varying.html">varying change points in mcp</a>.</li>
<li>
<code>cp_i_sd</code> is the population-level standard deviation of the varying effects.</li>
</ul>
<p>These parameter names are saved in <code>fit$pars</code>. Let us specify a somewhat complex model to show off some parameter names:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb3-1" title="1">segments =<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>(</a>
<a class="sourceLine" id="cb3-2" title="2">  <span class="co"># int_1</span></a>
<a class="sourceLine" id="cb3-3" title="3">  score <span class="op">~</span><span class="st"> </span><span class="dv">1</span>,</a>
<a class="sourceLine" id="cb3-4" title="4">  </a>
<a class="sourceLine" id="cb3-5" title="5">  <span class="co"># cp_1, cp_1_sd, cp_1_id, x_2</span></a>
<a class="sourceLine" id="cb3-6" title="6">  <span class="dv">1</span> <span class="op">+</span><span class="st"> </span>(<span class="dv">1</span><span class="op">|</span>id) <span class="op">~</span><span class="st"> </span><span class="dv">0</span> <span class="op">+</span><span class="st"> </span>year,</a>
<a class="sourceLine" id="cb3-7" title="7">  </a>
<a class="sourceLine" id="cb3-8" title="8">  <span class="co"># cp_2, cp_2_sd, cp_2_condition, int_2, x_2</span></a>
<a class="sourceLine" id="cb3-9" title="9">  <span class="dv">1</span> <span class="op">+</span><span class="st"> </span>(<span class="dv">1</span><span class="op">|</span>condition) <span class="op">~</span><span class="st"> </span><span class="dv">1</span> <span class="op">+</span><span class="st"> </span><span class="kw">rel</span>(year)</a>
<a class="sourceLine" id="cb3-10" title="10">)</a>
<a class="sourceLine" id="cb3-11" title="11"></a>
<a class="sourceLine" id="cb3-12" title="12"><span class="co"># Intepret, but do not sample.</span></a>
<a class="sourceLine" id="cb3-13" title="13">fit =<span class="st"> </span><span class="kw"><a href="../reference/mcp.html">mcp</a></span>(segments, <span class="dt">sample =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb3-14" title="14">fit<span class="op">$</span>pars</a></code></pre></div>
<pre><code>## $population
## [1] "int_1"   "int_3"   "year_2"  "year_3"  "cp_1"    "cp_2"    "cp_1_sd"
## [8] "cp_2_sd" "sigma"  
## 
## $varying
## [1] "cp_1_id"        "cp_2_condition"
## 
## $x
## [1] "year"
## 
## $y
## [1] "score"
## 
## $trials
## [1] NA</code></pre>
</div>
<div id="modeling-intercept-change-points" class="section level1">
<h1 class="hasAnchor">
<a href="#modeling-intercept-change-points" class="anchor"></a>Modeling intercept change points</h1>
<p>A change point is simply like an <code>ifelse</code> statement or multiplying with indicators (0s and 1s):</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb5-1" title="1"><span class="co"># Model parameters</span></a>
<a class="sourceLine" id="cb5-2" title="2">x =<span class="st"> </span><span class="dv">1</span><span class="op">:</span><span class="dv">20</span></a>
<a class="sourceLine" id="cb5-3" title="3">cp_<span class="dv">1</span> =<span class="st"> </span><span class="dv">12</span></a>
<a class="sourceLine" id="cb5-4" title="4">int_<span class="dv">1</span> =<span class="st"> </span><span class="dv">5</span></a>
<a class="sourceLine" id="cb5-5" title="5">int_<span class="dv">2</span> =<span class="st"> </span><span class="dv">10</span></a>
<a class="sourceLine" id="cb5-6" title="6"></a>
<a class="sourceLine" id="cb5-7" title="7"><span class="co"># Ifelse version</span></a>
<a class="sourceLine" id="cb5-8" title="8">y_ifelse =<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span>(x <span class="op">&lt;=</span><span class="st"> </span>cp_<span class="dv">1</span>, <span class="dt">yes =</span> int_<span class="dv">1</span>, <span class="dt">no =</span> int_<span class="dv">2</span>)</a>
<a class="sourceLine" id="cb5-9" title="9"></a>
<a class="sourceLine" id="cb5-10" title="10"><span class="co"># Indicator equivalent using dummy helpers</span></a>
<a class="sourceLine" id="cb5-11" title="11">cp_<span class="dv">0</span> =<span class="st"> </span><span class="op">-</span><span class="ot">Inf</span></a>
<a class="sourceLine" id="cb5-12" title="12">cp_<span class="dv">2</span> =<span class="st"> </span><span class="ot">Inf</span></a>
<a class="sourceLine" id="cb5-13" title="13">y_indicator =<span class="st"> </span>(x <span class="op">&gt;</span><span class="st"> </span>cp_<span class="dv">0</span>) <span class="op">*</span><span class="st"> </span>(x <span class="op">&lt;=</span><span class="st"> </span>cp_<span class="dv">1</span>) <span class="op">*</span><span class="st"> </span>int_<span class="dv">1</span> <span class="op">+</span><span class="st">  </span><span class="co"># Between cp_0 and cp_1</span></a>
<a class="sourceLine" id="cb5-14" title="14"><span class="st">              </span>(x <span class="op">&gt;</span><span class="st"> </span>cp_<span class="dv">1</span>) <span class="op">*</span><span class="st"> </span>(x <span class="op">&lt;=</span><span class="st"> </span>cp_<span class="dv">2</span>) <span class="op">*</span><span class="st"> </span>int_<span class="dv">2</span>  <span class="co"># Between cp_1 and cp_2</span></a>
<a class="sourceLine" id="cb5-15" title="15"></a>
<a class="sourceLine" id="cb5-16" title="16"><span class="co"># Show it</span></a>
<a class="sourceLine" id="cb5-17" title="17"><span class="kw"><a href="https://rdrr.io/r/graphics/par.html">par</a></span>(<span class="dt">mfrow =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="dv">1</span>,<span class="dv">2</span>))</a>
<a class="sourceLine" id="cb5-18" title="18"><span class="kw"><a href="../reference/plot.mcpfit.html">plot</a></span>(x, y_ifelse, <span class="dt">main =</span> <span class="st">"ifelse(x &lt;= cp_1)"</span>)</a>
<a class="sourceLine" id="cb5-19" title="19"><span class="kw"><a href="../reference/plot.mcpfit.html">plot</a></span>(x, y_indicator, <span class="dt">main =</span> <span class="st">"(x &gt; cp_1) * int_2"</span>)</a></code></pre></div>
<p><img src="formulas_files/figure-html/unnamed-chunk-3-1.png" width="700"></p>
<p>The magic of (Bayesian) MCMC sampling is that it can actually infer the change point from this simple formulation. We let <code>mcp</code> write the JAGS code for this simple two-plateaus model and see how it uses the indicator formulation of change points:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb6-1" title="1">segments =<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>(y <span class="op">~</span><span class="st"> </span><span class="dv">1</span>, <span class="dv">1</span> <span class="op">~</span><span class="st"> </span><span class="dv">1</span>)</a>
<a class="sourceLine" id="cb6-2" title="2">fit =<span class="st"> </span><span class="kw"><a href="../reference/mcp.html">mcp</a></span>(segments, <span class="dt">sample=</span><span class="ot">FALSE</span>, <span class="dt">par_x =</span> <span class="st">"x"</span>)</a>
<a class="sourceLine" id="cb6-3" title="3"><span class="kw"><a href="https://rdrr.io/r/base/cat.html">cat</a></span>(fit<span class="op">$</span>jags_code)</a></code></pre></div>
<pre><code>## 
## model {
##   # Priors for population-level effects
##   sigma ~ dnorm(0, 1/(SDY)^2) T(0, )
##   int_1 ~ dt(0, 1/(3*SDY)^2, 3) 
##   int_2 ~ dt(0, 1/(3*SDY)^2, 3) 
##   cp_1 ~ dunif(MINX, MAXX)
##   cp_0 = -10^100  # mcp helper value; minus infinity
##   cp_2 = 10^100  # mcp helper value; plus infinity
## 
## 
##   # Model and likelihood
##   for (i_ in 1:length(x)) {
## 
##     # Fitted value
##     y_[i_] = 
## 
##       # Segment 1: y ~ 1
##       (x[i_] &gt;= cp_0) * (x[i_] &lt; cp_1) * int_1 + 
##       
##       # Segment 2: y ~ 1 ~ 1
##       (x[i_] &gt;= cp_1) * int_2 
## 
##     # Likelihood and log-density for family = gaussian()
##     y[i_] ~ dnorm(y_[i_], 1 / sigma^2)
##     loglik_[i_] = logdensity.norm(y[i_], y_[i_], 1 / sigma^2)
##   }
## }</code></pre>
<p>Look at the section called <code># Fitted value</code> and you should recognize it. Some unnecessary stuff is added to segment 1 just because it makes the code easier to generate. (<code>x[i_] &gt;= cp_0</code> when <code>cp_0 = -10^100</code> is a way of writing <code>x &gt;= -Inf</code> in JAGS and this is, of course, always true).</p>
</div>
<div id="modeling-slope-change-points" class="section level1">
<h1 class="hasAnchor">
<a href="#modeling-slope-change-points" class="anchor"></a>Modeling slope change points</h1>
<p>We can use the same principle to model change points on slopes. However, we have to “take off” where the previous slope left us on the y-axis. That is, we have to regard whatever y-value the previous segment ended with as a kind of intercept-at-x=0 in the frame of the new segment. The intercept of segment 2 is <code>cp_1 * slope_1</code> and the slope in segment 2 is <code>x * (slope_2 - cp_1)</code>.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb8-1" title="1"><span class="co"># Model parameters</span></a>
<a class="sourceLine" id="cb8-2" title="2">x =<span class="st"> </span><span class="dv">1</span><span class="op">:</span><span class="dv">20</span></a>
<a class="sourceLine" id="cb8-3" title="3">cp_<span class="dv">1</span> =<span class="st"> </span><span class="dv">12</span></a>
<a class="sourceLine" id="cb8-4" title="4">slope_<span class="dv">1</span> =<span class="st"> </span><span class="dv">2</span></a>
<a class="sourceLine" id="cb8-5" title="5">slope_<span class="dv">2</span> =<span class="st"> </span><span class="dv">-1</span></a>
<a class="sourceLine" id="cb8-6" title="6"></a>
<a class="sourceLine" id="cb8-7" title="7"><span class="co"># Ifelse version</span></a>
<a class="sourceLine" id="cb8-8" title="8">y_ifelse =<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span>(x <span class="op">&lt;=</span><span class="st"> </span>cp_<span class="dv">1</span>, </a>
<a class="sourceLine" id="cb8-9" title="9">            <span class="dt">yes =</span> slope_<span class="dv">1</span> <span class="op">*</span><span class="st"> </span>x,</a>
<a class="sourceLine" id="cb8-10" title="10">            <span class="dt">no =</span> cp_<span class="dv">1</span> <span class="op">*</span><span class="st"> </span>slope_<span class="dv">1</span> <span class="op">+</span><span class="st"> </span>slope_<span class="dv">2</span> <span class="op">*</span><span class="st"> </span>(x <span class="op">-</span><span class="st"> </span>cp_<span class="dv">1</span>))</a>
<a class="sourceLine" id="cb8-11" title="11"></a>
<a class="sourceLine" id="cb8-12" title="12"><span class="co"># Indicator version. pmin() is a vectorized min()</span></a>
<a class="sourceLine" id="cb8-13" title="13">cp_<span class="dv">0</span> =<span class="st"> </span><span class="op">-</span><span class="ot">Inf</span></a>
<a class="sourceLine" id="cb8-14" title="14">y_indicator =<span class="st"> </span>(x <span class="op">&gt;</span><span class="st"> </span>cp_<span class="dv">0</span>) <span class="op">*</span><span class="st"> </span>slope_<span class="dv">1</span> <span class="op">*</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/Extremes.html">pmin</a></span>(x, cp_<span class="dv">1</span>) <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb8-15" title="15"><span class="st">              </span>(x <span class="op">&gt;</span><span class="st"> </span>cp_<span class="dv">1</span>) <span class="op">*</span><span class="st"> </span>slope_<span class="dv">2</span> <span class="op">*</span><span class="st"> </span>(x <span class="op">-</span><span class="st"> </span>cp_<span class="dv">1</span>)</a>
<a class="sourceLine" id="cb8-16" title="16"></a>
<a class="sourceLine" id="cb8-17" title="17"><span class="co"># Show it</span></a>
<a class="sourceLine" id="cb8-18" title="18"><span class="kw"><a href="https://rdrr.io/r/graphics/par.html">par</a></span>(<span class="dt">mfrow =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="dv">1</span>,<span class="dv">2</span>))</a>
<a class="sourceLine" id="cb8-19" title="19"><span class="kw"><a href="../reference/plot.mcpfit.html">plot</a></span>(x, y_ifelse, <span class="dt">main =</span> <span class="st">"ifelse(x &lt;= cp_1)"</span>)</a>
<a class="sourceLine" id="cb8-20" title="20"><span class="kw"><a href="../reference/plot.mcpfit.html">plot</a></span>(x, y_indicator, <span class="dt">main =</span> <span class="st">"(x &gt; cp_1) * int_2"</span>)</a></code></pre></div>
<p><img src="formulas_files/figure-html/unnamed-chunk-5-1.png" width="700"></p>
<p>Let us see this in action:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb9-1" title="1">segments =<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>(y <span class="op">~</span><span class="st"> </span><span class="dv">0</span> <span class="op">+</span><span class="st"> </span>x,</a>
<a class="sourceLine" id="cb9-2" title="2">                <span class="dv">1</span> <span class="op">~</span><span class="st"> </span><span class="dv">0</span> <span class="op">+</span><span class="st"> </span>x)</a>
<a class="sourceLine" id="cb9-3" title="3">fit =<span class="st"> </span><span class="kw"><a href="../reference/mcp.html">mcp</a></span>(segments, <span class="dt">sample =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb9-4" title="4"><span class="kw"><a href="https://rdrr.io/r/base/cat.html">cat</a></span>(fit<span class="op">$</span>jags_code)</a></code></pre></div>
<pre><code>## 
## model {
##   # Priors for population-level effects
##   sigma ~ dnorm(0, 1/(SDY)^2) T(0, )
##   x_1 ~ dt(0, 1/(SDY/(MAXX-MINX))^2, 3) 
##   x_2 ~ dt(0, 1/(SDY/(MAXX-MINX))^2, 3) 
##   cp_1 ~ dunif(MINX, MAXX)
##   cp_0 = -10^100  # mcp helper value; minus infinity
##   cp_2 = 10^100  # mcp helper value; plus infinity
## 
## 
##   # Model and likelihood
##   for (i_ in 1:length(x)) {
## 
##     # Fitted value
##     y_[i_] = 
## 
##       # Segment 1: y ~ 0 + x
##       (x[i_] &gt;= cp_0) * (x_1 * (min(x[i_], cp_1))) + 
##       
##       # Segment 2: y ~ 1 ~ 0 + x
##       (x[i_] &gt;= cp_1) * (x_2 * (min(x[i_], cp_2) - (cp_1))) 
## 
##     # Likelihood and log-density for family = gaussian()
##     y[i_] ~ dnorm(y_[i_], 1 / sigma^2)
##     loglik_[i_] = logdensity.norm(y[i_], y_[i_], 1 / sigma^2)
##   }
## }</code></pre>
<p>Again, look at the <code>#Fitted value</code> to see the indicator-version in action. And again, <code>mcp</code> adds something about <code>cp_0 = -Inf</code> and <code>cp_2 = Inf</code>, just for internal convenience.</p>
<p>This exact code is also used in <code>fit$func_y</code>. See under <code>"Fitted value</code>:</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb11-1" title="1"><span class="kw"><a href="../reference/print.mcpfit.html">print</a></span>(fit<span class="op">$</span>func_y)</a></code></pre></div>
<pre><code>## function (x, x_1, x_2, cp_1, sigma, type = "predict", rate = FALSE, 
##     ...) 
## {
##     cp_0 = -Inf
##     cp_2 = Inf
##     y = (x &gt;= cp_0) * (x_1 * (pmin(x, cp_1))) + (x &gt;= cp_1) * 
##         (x_2 * (pmin(x, cp_2) - (cp_1)))
##     if (!type %in% c("predict", "fitted")) 
##         stop("'`type` must be one of 'predict' or 'fitted'")
##     if (type == "predict") 
##         return(rnorm(length(x), y, sigma))
##     if (type == "fitted") 
##         return(y)
## }
## &lt;environment: 0x00000000199e21c0&gt;</code></pre>
</div>
<div id="modeling-relative-slopes-and-intercepts" class="section level1">
<h1 class="hasAnchor">
<a href="#modeling-relative-slopes-and-intercepts" class="anchor"></a>Modeling relative slopes and intercepts</h1>
<p><code>mcp</code> allows for specifying relative intercepts and change points through <code>rel()</code>. Relative slopes are easy: just replace <code>x_2</code> with <code>x_1 + x_2</code>. You could do the same if all segments are intercept-only. However, if the previous segment had a slope, we want the intercept to be relative to where that “ended”. The <code>mcp</code> solution is to only “turn off” (using an indicator) the “hanging intercept” from that slope’s ending (<code><a href="https://rdrr.io/r/base/Extremes.html">pmin(x, cp_i)</a></code>) when the model encounters an absolute intercept.</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb13-1" title="1"><span class="co"># Model parameters</span></a>
<a class="sourceLine" id="cb13-2" title="2">x =<span class="st"> </span><span class="dv">1</span><span class="op">:</span><span class="dv">20</span></a>
<a class="sourceLine" id="cb13-3" title="3">cp_<span class="dv">1</span> =<span class="st"> </span><span class="dv">12</span></a>
<a class="sourceLine" id="cb13-4" title="4">int_<span class="dv">1</span> =<span class="st"> </span><span class="dv">5</span></a>
<a class="sourceLine" id="cb13-5" title="5">int_<span class="dv">2</span> =<span class="st"> </span><span class="dv">3</span>  <span class="co"># let's model this as relative</span></a>
<a class="sourceLine" id="cb13-6" title="6"></a>
<a class="sourceLine" id="cb13-7" title="7"><span class="co"># Indicator version.</span></a>
<a class="sourceLine" id="cb13-8" title="8">cp_<span class="dv">0</span> =<span class="st"> </span><span class="op">-</span><span class="ot">Inf</span></a>
<a class="sourceLine" id="cb13-9" title="9">y_indicator =<span class="st"> </span>(x <span class="op">&gt;</span><span class="st"> </span>cp_<span class="dv">0</span>) <span class="op">*</span><span class="st"> </span>int_<span class="dv">1</span> <span class="op">+</span><span class="st">  </span><span class="co"># Note: no (x &lt; cp_1)</span></a>
<a class="sourceLine" id="cb13-10" title="10"><span class="st">              </span>(x <span class="op">&gt;</span><span class="st"> </span>cp_<span class="dv">1</span>) <span class="op">*</span><span class="st"> </span>(int_<span class="dv">2</span>)</a>
<a class="sourceLine" id="cb13-11" title="11"></a>
<a class="sourceLine" id="cb13-12" title="12"><span class="co"># Plot it</span></a>
<a class="sourceLine" id="cb13-13" title="13"><span class="kw"><a href="../reference/plot.mcpfit.html">plot</a></span>(x, y_indicator, <span class="dt">main =</span> <span class="st">"Relative intercept"</span>)</a></code></pre></div>
<p><img src="formulas_files/figure-html/unnamed-chunk-8-1.png" width="700"></p>
<p>You can look at <code><a href="https://rdrr.io/r/base/cat.html">cat(fit$jags_code)</a></code> and <code>fit$func_y</code> to see this in action.</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">

        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#parameter-names">Parameter names</a></li>
      <li><a href="#modeling-intercept-change-points">Modeling intercept change points</a></li>
      <li><a href="#modeling-slope-change-points">Modeling slope change points</a></li>
      <li><a href="#modeling-relative-slopes-and-intercepts">Modeling relative slopes and intercepts</a></li>
      </ul>
</div>
      </div>

</div>



      <footer><div class="copyright">
  <p>Developed by Jonas Lindeløv.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.4.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
