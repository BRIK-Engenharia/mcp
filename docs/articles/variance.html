<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Modeling variance and variance changes in mcp • mcp</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.3.7/flatly/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha256-U5ZEeKfGNOja007MMD3YBI0A3OSZOQbeG6z2f2Y0hu8=" crossorigin="anonymous"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.1/css/all.min.css" integrity="sha256-nAmazAk6vS34Xqo0BSrTb+abbtFlgsFK7NKSi6o7Y78=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.1/css/v4-shims.min.css" integrity="sha256-6qHlizsOWFskGlwVOKuns+D1nB6ssZrHQrNj1wGplHc=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/headroom.min.js" integrity="sha256-DJFC1kqIhelURkuza0AvYal5RxMtpzLjFhsnVIeuk+U=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><!-- docsearch --><script src="../docsearch.js"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/docsearch.js/2.6.1/docsearch.min.css" integrity="sha256-QOSRU/ra9ActyXkIBbiIB144aDBdtvXBcNc3OTNuX/Q=" crossorigin="anonymous">
<link href="../docsearch.css" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/jquery.mark.min.js" integrity="sha256-4HLtjeVgH0eIB3aZ9mLYF6E8oU5chNdjU6p6rrXpl9U=" crossorigin="anonymous"></script><link href="../extra.css" rel="stylesheet">
<meta property="og:title" content="Modeling variance and variance changes in mcp">
<meta property="og:description" content="">
<meta property="og:image" content="https://lindeloev.github.io/mcp/logo.png">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-1026978-3"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-1026978-3');
</script>
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">mcp</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.2.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    General usage
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/formulas.html">Formulas</a>
    </li>
    <li>
      <a href="../articles/priors.html">Priors</a>
    </li>
    <li>
      <a href="../articles/comparison.html">Hypotheses and model comparison</a>
    </li>
    <li>
      <a href="../articles/varying.html">Random/varying effects</a>
    </li>
    <li>
      <a href="../articles/variance.html">Modeling variance</a>
    </li>
    <li>
      <a href="../articles/arma.html">Time series and autocorrelation</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    GLM
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/poisson.html">Poisson</a>
    </li>
    <li>
      <a href="../articles/binomial.html">Binomial and Bernoulli</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Other
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/packages.html">Comparison to other packages</a>
    </li>
    <li>
      <a href="../articles/debug.html">Tips, tricks, and debugging</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">News</a>
</li>
<li>
  <a href="https://twitter.com/jonaslindeloev">
    <span class="fa fa-twitter"></span>
     
  </a>
</li>
<li>
  <a href="https://github.com/lindeloev/mcp">
    <span class="fa fa-github"></span>
     
  </a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/lindeloev/mcp">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
<form class="navbar-form navbar-right hidden-xs hidden-sm" role="search">
        <div class="form-group">
          <input type="search" class="form-control" name="search-input" id="search-input" placeholder="Search..." aria-label="Search for..." autocomplete="off">
</div>
      </form>
      
    </div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>Modeling variance and variance changes in mcp</h1>
                        <h4 class="author">Jonas Kristoffer Lindeløv</h4>
            
            <h4 class="date">2019-12-02</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/lindeloev/mcp/blob/master/vignettes/variance.Rmd"><code>vignettes/variance.Rmd</code></a></small>
      <div class="hidden name"><code>variance.Rmd</code></div>

    </div>

    
    
<p>For GLM families with a variance parameter (<code>sigma</code>), you can model this explicitly. For example, if you want a flat mean (a plateau) with increasing variance, you can do <code>y ~ 1 + sigma(1 + x)</code>. In general, all formula syntax that is allowed outside of <code><a href="https://rdrr.io/r/stats/sigma.html">sigma()</a></code> (where it applies to the mean) also works inside it (applying to the variance). For example, if you go all-out, you can do <code>~ 1 + sigma(rel(1) + sin(x) + I(x^2))</code>. Read more about mcp formulas <a href="../articles/formulas.html">here</a>.</p>
<div id="simple-example-a-change-in-variance" class="section level1">
<h1 class="hasAnchor">
<a href="#simple-example-a-change-in-variance" class="anchor"></a>Simple example: a change in variance</h1>
<p>Let us model a simple change in variance on a plateau model. First, we specify the model:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" title="1">segments =<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>(</a>
<a class="sourceLine" id="cb1-2" title="2">  y <span class="op">~</span><span class="st"> </span><span class="dv">1</span>,  <span class="co"># sigma(1) is implicit in the first segment</span></a>
<a class="sourceLine" id="cb1-3" title="3">  <span class="op">~</span><span class="st"> </span><span class="dv">0</span> <span class="op">+</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/stats/sigma.html">sigma</a></span>(<span class="dv">1</span>)  <span class="co"># a new intercept on sigma, but not on the mean</span></a>
<a class="sourceLine" id="cb1-4" title="4">)</a></code></pre></div>
<p>We can simulate some data, starting with low variance and an abrupt change to a high variance at <span class="math inline">\(x = 50\)</span>:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb2-1" title="1"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(mcp)</a>
<a class="sourceLine" id="cb2-2" title="2"><span class="kw"><a href="https://rdrr.io/r/base/options.html">options</a></span>(<span class="dt">mc.cores =</span> <span class="dv">3</span>)  <span class="co"># Speed up sampling!</span></a>
<a class="sourceLine" id="cb2-3" title="3"></a>
<a class="sourceLine" id="cb2-4" title="4">empty =<span class="st"> </span><span class="kw"><a href="../reference/mcp.html">mcp</a></span>(segments, <span class="dt">sample =</span> <span class="ot">FALSE</span>, <span class="dt">par_x =</span> <span class="st">"x"</span>)</a>
<a class="sourceLine" id="cb2-5" title="5"><span class="kw"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span>(<span class="dv">40</span>)</a>
<a class="sourceLine" id="cb2-6" title="6">data =<span class="st"> </span>tibble<span class="op">::</span><span class="kw"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span>(</a>
<a class="sourceLine" id="cb2-7" title="7">  <span class="dt">x =</span> <span class="dv">1</span><span class="op">:</span><span class="dv">100</span>,</a>
<a class="sourceLine" id="cb2-8" title="8">  <span class="dt">y =</span> empty<span class="op">$</span><span class="kw"><a href="https://rdrr.io/r/stats/simulate.html">simulate</a></span>(x, <span class="dt">cp_1 =</span> <span class="dv">50</span>, <span class="dt">int_1 =</span> <span class="dv">20</span>, </a>
<a class="sourceLine" id="cb2-9" title="9">                   <span class="dt">sigma_1 =</span> <span class="dv">5</span>, <span class="dt">sigma_2 =</span> <span class="dv">20</span>)</a>
<a class="sourceLine" id="cb2-10" title="10">)</a></code></pre></div>
<p>Now we fit the model to the simulated data.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb3-1" title="1">fit =<span class="st"> </span><span class="kw"><a href="../reference/mcp.html">mcp</a></span>(segments, data, <span class="dt">par_x =</span> <span class="st">"x"</span>)</a></code></pre></div>
<p>We plot the results with the prediction interval to show the effect of the variance, since it won’t be immediately obvious on the default plot of the fitted mean predictions:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb4-1" title="1"><span class="kw"><a href="../reference/plot.mcpfit.html">plot</a></span>(fit, <span class="dt">quantiles =</span> <span class="ot">TRUE</span>, <span class="dt">quantiles_type =</span> <span class="st">"predict"</span>)</a></code></pre></div>
<p><img src="variance_files/figure-html/unnamed-chunk-4-1.png" width="700"></p>
<p>We can see all parameters are well recovered. Like the other parameters, the <code>sigma</code>s are named after the segment where they were instantiated. There will always be a <code>sigma_1</code>.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb5-1" title="1"><span class="kw"><a href="../reference/summary.mcpfit.html">summary</a></span>(fit)</a></code></pre></div>
<pre><code>## Family: gaussian(link = 'identity')
## Iterations: 9000 from 3 chains.
## Segments:
##   1: y ~ 1
##   2: y ~ 1 ~ 0 + sigma(1)
## 
## Population-level parameters:
##     name  mean lower upper Rhat n.eff  ts_se
##     cp_1 49.80 46.05 54.48    1  1635 17.224
##    int_1 20.36 18.92 21.92    1  4987  0.976
##  sigma_1  5.58  4.46  6.78    1  3373  0.975
##  sigma_2 19.04 15.55 22.73    1  4859  6.339</code></pre>
</div>
<div id="advanced-example" class="section level1">
<h1 class="hasAnchor">
<a href="#advanced-example" class="anchor"></a>Advanced example</h1>
<p>We can model changes in <code>sigma</code> alone or in combination with changes in the mean. In the following, I define a needlessly complex model, just to demonstrate the flexibility of modeling variance:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb7-1" title="1">segments =<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>(</a>
<a class="sourceLine" id="cb7-2" title="2">  <span class="co"># Increasing variance.</span></a>
<a class="sourceLine" id="cb7-3" title="3">  y <span class="op">~</span><span class="st"> </span><span class="dv">1</span> <span class="op">+</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/stats/sigma.html">sigma</a></span>(<span class="dv">1</span> <span class="op">+</span><span class="st"> </span>x),</a>
<a class="sourceLine" id="cb7-4" title="4">  </a>
<a class="sourceLine" id="cb7-5" title="5">  <span class="co"># Abrupt change in mean and variance.</span></a>
<a class="sourceLine" id="cb7-6" title="6">  <span class="op">~</span><span class="st"> </span><span class="dv">1</span> <span class="op">+</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/stats/sigma.html">sigma</a></span>(<span class="dv">1</span>),</a>
<a class="sourceLine" id="cb7-7" title="7">  </a>
<a class="sourceLine" id="cb7-8" title="8">  <span class="co"># Joined slope on mean. variance changes as 2nd order poly.</span></a>
<a class="sourceLine" id="cb7-9" title="9">  <span class="op">~</span><span class="st"> </span><span class="dv">0</span> <span class="op">+</span><span class="st"> </span>x <span class="op">+</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/stats/sigma.html">sigma</a></span>(<span class="dv">0</span> <span class="op">+</span><span class="st"> </span>x <span class="op">+</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/AsIs.html">I</a></span>(x<span class="op">^</span><span class="dv">2</span>)),</a>
<a class="sourceLine" id="cb7-10" title="10">  </a>
<a class="sourceLine" id="cb7-11" title="11">  <span class="co"># Continue slope on mean, but plateau variance (no sigma() tern).</span></a>
<a class="sourceLine" id="cb7-12" title="12">  <span class="op">~</span><span class="st"> </span><span class="dv">0</span> <span class="op">+</span><span class="st"> </span>x</a>
<a class="sourceLine" id="cb7-13" title="13">)</a>
<a class="sourceLine" id="cb7-14" title="14"></a>
<a class="sourceLine" id="cb7-15" title="15"><span class="co"># The slope in segment 4 is just a continuation of </span></a>
<a class="sourceLine" id="cb7-16" title="16"><span class="co"># the slope in segment 3, as if there was no change point.</span></a>
<a class="sourceLine" id="cb7-17" title="17">prior =<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>(</a>
<a class="sourceLine" id="cb7-18" title="18">  <span class="dt">x_4 =</span> <span class="st">"x_3"</span></a>
<a class="sourceLine" id="cb7-19" title="19">)</a></code></pre></div>
<p>Notice a few things here:</p>
<ul>
<li>Segment 3 and 4: I changed the variance on a continuous slope. You can do this using priors to define that the slope is shared between segment 3 and 4, effectively canceling the change point on the mean (more about using priors in mcp <a href="../articles/priors.html">here</a>).</li>
<li>Segment 4: By not specifying <code><a href="https://rdrr.io/r/stats/sigma.html">sigma()</a></code>, segment 4 (and later segments) just inherits the variance from the state it was left in in the previous segment.</li>
</ul>
<p>In general, the variance parameters are named <code>sigma_[normalname]</code>, where “normalname” is the usual parameter names in mcp (see more <a href="../articles/formulas.html">here</a>). For example, the variance slope on <code>x</code> in segment 3 is <code>sigma_x_3</code>. However, <code>sigma_int_i</code> is just too verbose, so variance intercepts are simply called <code>sigma_i</code>, where i is the segment number.</p>
<div id="simulate-data" class="section level2">
<h2 class="hasAnchor">
<a href="#simulate-data" class="anchor"></a>Simulate data</h2>
<p>We simulate some data from this model, setting all parameters. As always, we can fit an empty model to get <code>fit$simulate</code>, which is useful for simulation and predictions from this model.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb8-1" title="1">empty =<span class="st"> </span><span class="kw"><a href="../reference/mcp.html">mcp</a></span>(segments, <span class="dt">sample =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb8-2" title="2"><span class="kw"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span>(<span class="dv">40</span>)</a>
<a class="sourceLine" id="cb8-3" title="3">data =<span class="st"> </span>tibble<span class="op">::</span><span class="kw"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span>(</a>
<a class="sourceLine" id="cb8-4" title="4">  <span class="dt">x =</span> <span class="dv">1</span><span class="op">:</span><span class="dv">200</span>,</a>
<a class="sourceLine" id="cb8-5" title="5">  <span class="dt">y =</span> empty<span class="op">$</span><span class="kw"><a href="https://rdrr.io/r/stats/simulate.html">simulate</a></span>(x,</a>
<a class="sourceLine" id="cb8-6" title="6">    <span class="dt">cp_1 =</span> <span class="dv">50</span>, <span class="dt">cp_2 =</span> <span class="dv">100</span>, <span class="dt">cp_3 =</span> <span class="dv">150</span>,</a>
<a class="sourceLine" id="cb8-7" title="7">    <span class="dt">int_1 =</span> <span class="dv">-20</span>, <span class="dt">int_2 =</span> <span class="dv">0</span>,</a>
<a class="sourceLine" id="cb8-8" title="8">    <span class="dt">sigma_1 =</span> <span class="dv">3</span>, <span class="dt">sigma_x_1 =</span> <span class="fl">0.5</span>,</a>
<a class="sourceLine" id="cb8-9" title="9">    <span class="dt">sigma_2 =</span> <span class="dv">10</span>, </a>
<a class="sourceLine" id="cb8-10" title="10">    <span class="dt">sigma_x_3 =</span> <span class="fl">-0.5</span>,</a>
<a class="sourceLine" id="cb8-11" title="11">    <span class="dt">sigma_x_3_E2 =</span> <span class="fl">0.02</span>,</a>
<a class="sourceLine" id="cb8-12" title="12">    <span class="dt">x_3 =</span> <span class="dv">1</span>, <span class="dt">x_4 =</span> <span class="dv">1</span>)</a>
<a class="sourceLine" id="cb8-13" title="13">)</a></code></pre></div>
</div>
<div id="fit-it-and-inspect-results" class="section level2">
<h2 class="hasAnchor">
<a href="#fit-it-and-inspect-results" class="anchor"></a>Fit it and inspect results</h2>
<p>Fit it in parallel, to speed things up:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb9-1" title="1">fit =<span class="st"> </span><span class="kw"><a href="../reference/mcp.html">mcp</a></span>(segments, data, prior)</a></code></pre></div>
<p>Plotting the prediction interval is the easiest way to to see how the variance is estimated:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb10-1" title="1"><span class="kw"><a href="../reference/plot.mcpfit.html">plot</a></span>(fit, <span class="dt">quantiles =</span> <span class="ot">TRUE</span>, <span class="dt">quantiles_type =</span> <span class="st">"predict"</span>)</a></code></pre></div>
<p><img src="variance_files/figure-html/unnamed-chunk-9-1.png" width="700"></p>
<p>The parameters are well recovered. The last change point is estimated with greater uncertainty than the others. This is expected, given that the only “signal” of this change point is a stop in variance growth.</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb11-1" title="1"><span class="kw"><a href="../reference/summary.mcpfit.html">summary</a></span>(fit)</a></code></pre></div>
<pre><code>## Family: gaussian(link = 'identity')
## Iterations: 9000 from 3 chains.
## Segments:
##   1: y ~ 1 + sigma(1 + x)
##   2: y ~ 1 ~ 1 + sigma(1)
##   3: y ~ 1 ~ 0 + x + sigma(0 + x + I(x^2))
##   4: y ~ 1 ~ 0 + x
## 
## Population-level parameters:
##          name     mean     lower    upper Rhat n.eff    ts_se
##          cp_1  49.8089  49.00034  51.3913    1  2214 2.54e+00
##          cp_2 100.0181  93.88676 105.8795    1   534 1.35e+02
##          cp_3 162.5579 143.95541 181.7464    1   203 3.25e+03
##         int_1 -20.4126 -23.71776 -17.5019    1  4829 4.75e+00
##         int_2   1.3673  -1.34319   4.0197    1  1233 9.61e+00
##       sigma_1   3.4714   0.40540   7.1746    1  1067 2.45e+01
##       sigma_2   9.6211   8.01787  11.4609    1  1498 4.87e+00
##     sigma_x_1   0.5394   0.33699   0.7434    1  1309 6.11e-02
##     sigma_x_3  -0.2300  -0.66328   0.1095    1   111 2.89e+00
##  sigma_x_3_E2   0.0129   0.00346   0.0268    1    79 4.48e-03
##           x_3   0.9339   0.77564   1.1037    1  1103 5.06e-02
##           x_4   0.9339   0.77564   1.1037    1  1103 5.06e-02</code></pre>
<p>The effective sample size (<code>n.eff</code>) is fairly low, indicating poor mixing for these parameters. <code>Rhat</code> is acceptable at &lt; 1.1, indicating good convergence between chains. Let us verify this by taking a look at the posteriors and trace. For now, we just look at the sigmas:</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb13-1" title="1"><span class="kw"><a href="../reference/plot_pars.html">plot_pars</a></span>(fit, <span class="dt">regex_pars =</span> <span class="st">"sigma_"</span>)</a></code></pre></div>
<p><img src="variance_files/figure-html/unnamed-chunk-11-1.png" width="576"></p>
<p>This confirms the impression from <code>Rhat</code> and <code>n.eff</code>. Setting <code><a href="../reference/mcp.html">mcp(..., iter = 10000)</a></code> would be advisable to increase the effective sample size. Read more about <a href="../articles/tips.html">tips, tricks, and debugging</a>.</p>
</div>
</div>
<div id="varying-change-points-and-variance" class="section level1">
<h1 class="hasAnchor">
<a href="#varying-change-points-and-variance" class="anchor"></a>Varying change points and variance</h1>
<p>The variance model applies to varying change points as well. For example, here we do a spin on the example in <a href="../articles/varying.html">the article on varying change points</a>, and add a by-person change in <code>sigma</code>. We model two joined slopes, varying by <code>id</code>. The second slope is also characterized by a different variance. This means that the model has more information about when the change point occurs, so it should be easier to estimate (require fewer data).</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb14-1" title="1">segments =<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>(</a>
<a class="sourceLine" id="cb14-2" title="2">  <span class="co"># intercept + slope</span></a>
<a class="sourceLine" id="cb14-3" title="3">  y <span class="op">~</span><span class="st"> </span><span class="dv">1</span> <span class="op">+</span><span class="st"> </span>x,</a>
<a class="sourceLine" id="cb14-4" title="4">  </a>
<a class="sourceLine" id="cb14-5" title="5">  <span class="co"># joined slope and increase in variance, varying by id.</span></a>
<a class="sourceLine" id="cb14-6" title="6">  <span class="dv">1</span> <span class="op">+</span><span class="st"> </span>(<span class="dv">1</span><span class="op">|</span>id) <span class="op">~</span><span class="st"> </span><span class="dv">0</span> <span class="op">+</span><span class="st"> </span>x <span class="op">+</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/stats/sigma.html">sigma</a></span>(<span class="dv">1</span>)</a>
<a class="sourceLine" id="cb14-7" title="7">)</a></code></pre></div>
<p>Simulate data:</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb15-1" title="1">empty =<span class="st"> </span><span class="kw"><a href="../reference/mcp.html">mcp</a></span>(segments, <span class="dt">sample =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb15-2" title="2"><span class="kw"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span>(<span class="dv">40</span>)</a>
<a class="sourceLine" id="cb15-3" title="3">data =<span class="st"> </span>tibble<span class="op">::</span><span class="kw"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span>(</a>
<a class="sourceLine" id="cb15-4" title="4">    <span class="dt">x =</span> <span class="dv">1</span><span class="op">:</span><span class="dv">180</span>,</a>
<a class="sourceLine" id="cb15-5" title="5">    <span class="dt">id =</span> <span class="kw"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="dv">1</span><span class="op">:</span><span class="dv">6</span>, <span class="dt">times =</span> <span class="dv">30</span>),</a>
<a class="sourceLine" id="cb15-6" title="6">    <span class="dt">y =</span> empty<span class="op">$</span><span class="kw"><a href="https://rdrr.io/r/stats/simulate.html">simulate</a></span>(x, </a>
<a class="sourceLine" id="cb15-7" title="7">          <span class="dt">cp_1 =</span> <span class="dv">70</span>, <span class="dt">cp_1_id =</span> <span class="dv">15</span> <span class="op">*</span><span class="st"> </span>(id <span class="op">-</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/mean.html">mean</a></span>(id)),</a>
<a class="sourceLine" id="cb15-8" title="8">          <span class="dt">int_1 =</span> <span class="dv">20</span>, <span class="dt">x_1 =</span> <span class="dv">1</span>, <span class="dt">x_2 =</span> <span class="fl">-0.5</span>,</a>
<a class="sourceLine" id="cb15-9" title="9">          <span class="dt">sigma_1 =</span> <span class="dv">10</span>, <span class="dt">sigma_2 =</span> <span class="dv">25</span>)</a>
<a class="sourceLine" id="cb15-10" title="10">)</a></code></pre></div>
<p>Fit it:</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb16-1" title="1">fit =<span class="st"> </span><span class="kw"><a href="../reference/mcp.html">mcp</a></span>(segments, data)</a></code></pre></div>
<p>Plot it with 80% prediction intervals:</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb17-1" title="1"><span class="kw"><a href="../reference/plot.mcpfit.html">plot</a></span>(fit, <span class="dt">facet_by =</span> <span class="st">"id"</span>, <span class="dt">quantiles =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">0.1</span>, <span class="fl">0.9</span>), <span class="dt">quantiles_type =</span> <span class="st">"predict"</span>)</a></code></pre></div>
<p><img src="variance_files/figure-html/unnamed-chunk-15-1.png" width="700"></p>
<p>As usual, we can get the individual change points:</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb18-1" title="1"><span class="kw"><a href="../reference/ranef.html">ranef</a></span>(fit)</a></code></pre></div>
<pre><code>##         name       mean      lower     upper      Rhat n.eff    ts_se
## 1 cp_1_id[1] -36.803803 -43.029507 -31.56424 1.0043381  1901 36.53680
## 2 cp_1_id[2] -16.417854 -22.898200 -10.12980 1.0006091  4513 20.18372
## 3 cp_1_id[3]  -9.158917 -15.247428  -2.62044 1.0014506  3463 26.47360
## 4 cp_1_id[4]   9.013984   3.375774  14.33297 0.9998304  3429 19.99447
## 5 cp_1_id[5]  16.733774  10.796419  23.05572 1.0010856  3957 21.58368
## 6 cp_1_id[6]  36.632817  29.991896  43.06718 1.0064578  1853 45.55852</code></pre>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">

        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#simple-example-a-change-in-variance">Simple example: a change in variance</a></li>
      <li>
<a href="#advanced-example">Advanced example</a><ul class="nav nav-pills nav-stacked">
<li><a href="#simulate-data">Simulate data</a></li>
      <li><a href="#fit-it-and-inspect-results">Fit it and inspect results</a></li>
      </ul>
</li>
      <li><a href="#varying-change-points-and-variance">Varying change points and variance</a></li>
      </ul>
</div>
      </div>

</div>



      <footer><div class="copyright">
  <p>Developed by <a href="http://lindeloev.net">Jonas Kristoffer Lindeløv</a>.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.4.1.</p>
</div>

      </footer>
</div>

  
<script src="https://cdnjs.cloudflare.com/ajax/libs/docsearch.js/2.6.1/docsearch.min.js" integrity="sha256-GKvGqXDznoRYHCwKXGnuchvKSwmx9SRMrZOTh2g4Sb0=" crossorigin="anonymous"></script><script>
  docsearch({
    
    
    apiKey: '702ab134d40a7310606c29f341fc5014',
    indexName: 'lindeloev_mcp',
    inputSelector: 'input#search-input.form-control',
    transformData: function(hits) {
      return hits.map(function (hit) {
        hit.url = updateHitURL(hit);
        return hit;
      });
    }
  });
</script>
</body>
</html>
