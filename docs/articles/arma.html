<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Time series change points with mcp • mcp</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.3.7/flatly/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha256-U5ZEeKfGNOja007MMD3YBI0A3OSZOQbeG6z2f2Y0hu8=" crossorigin="anonymous"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.1/css/all.min.css" integrity="sha256-nAmazAk6vS34Xqo0BSrTb+abbtFlgsFK7NKSi6o7Y78=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.1/css/v4-shims.min.css" integrity="sha256-6qHlizsOWFskGlwVOKuns+D1nB6ssZrHQrNj1wGplHc=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/headroom.min.js" integrity="sha256-DJFC1kqIhelURkuza0AvYal5RxMtpzLjFhsnVIeuk+U=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><!-- docsearch --><script src="../docsearch.js"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/docsearch.js/2.6.1/docsearch.min.css" integrity="sha256-QOSRU/ra9ActyXkIBbiIB144aDBdtvXBcNc3OTNuX/Q=" crossorigin="anonymous">
<link href="../docsearch.css" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/jquery.mark.min.js" integrity="sha256-4HLtjeVgH0eIB3aZ9mLYF6E8oU5chNdjU6p6rrXpl9U=" crossorigin="anonymous"></script><link href="../extra.css" rel="stylesheet">
<meta property="og:title" content="Time series change points with mcp">
<meta property="og:description" content="">
<meta property="og:image" content="https://lindeloev.github.io/mcp, https://github.com/lindeloev/mcp/logo.png">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-1026978-3"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-1026978-3');
</script>
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">mcp</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.2.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    General usage
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/formulas.html">Formulas</a>
    </li>
    <li>
      <a href="../articles/priors.html">Priors</a>
    </li>
    <li>
      <a href="../articles/comparison.html">Hypotheses and model comparison</a>
    </li>
    <li>
      <a href="../articles/varying.html">Random/varying effects</a>
    </li>
    <li>
      <a href="../articles/variance.html">Modeling variance</a>
    </li>
    <li>
      <a href="../articles/arma.html">Time series and autocorrelation</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    GLM
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/poisson.html">Poisson</a>
    </li>
    <li>
      <a href="../articles/binomial.html">Binomial and Bernoulli</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Other
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/packages.html">Comparison to other packages</a>
    </li>
    <li>
      <a href="../articles/debug.html">Tips, tricks, and debugging</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">News</a>
</li>
<li>
  <a href="https://twitter.com/jonaslindeloev">
    <span class="fa fa-twitter"></span>
     
  </a>
</li>
<li>
  <a href="https://github.com/lindeloev/mcp">
    <span class="fa fa-github"></span>
     
  </a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/lindeloev/mcp">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
<form class="navbar-form navbar-right hidden-xs hidden-sm" role="search">
        <div class="form-group">
          <input type="search" class="form-control" name="search-input" id="search-input" placeholder="Search..." aria-label="Search for..." autocomplete="off">
</div>
      </form>
      
    </div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>Time series change points with mcp</h1>
                        <h4 class="author">Jonas Kristoffer Lindeløv</h4>
            
            <h4 class="date">2019-12-02</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/lindeloev/mcp/blob/master/vignettes/arma.Rmd"><code>vignettes/arma.Rmd</code></a></small>
      <div class="hidden name"><code>arma.Rmd</code></div>

    </div>

    
    
<!--
 * Compute fit and interpret it
 * Warnings
 * Make a demo dataset and add to README
-->
<p>Autocorrelation is common in time series. You can specify N-order autoregressive models using <code><a href="https://rdrr.io/r/stats/ar.html">ar(N)</a></code> in the segment formulas. For most use cases, you just want to specify <code><a href="https://rdrr.io/r/stats/ar.html">ar(1)</a></code> in the first segment so that it “carries over” to other segments, just like all other intercepts in mcp. You can do regression on the autocorrelation parameters using <code><a href="https://rdrr.io/r/stats/ar.html">ar(N, formula)</a></code> and it behaves much like <a href="../articles/variance.html"><code>sigma</code> to model variance</a>.</p>
<div id="simple-example" class="section level1">
<h1 class="hasAnchor">
<a href="#simple-example" class="anchor"></a>Simple example</h1>
<p>Let’s try and model the <code>ex_ar</code> dataset. Take at look at <a href="https://github.com/lindeloev/mcp/tree/master/data-raw/ex_ar.R">how it was simulated</a> and scroll down to see another simulation.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" title="1"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(mcp)</a>
<a class="sourceLine" id="cb1-2" title="2"><span class="kw"><a href="https://rdrr.io/r/base/options.html">options</a></span>(<span class="dt">mc.cores =</span> <span class="dv">3</span>)  <span class="co"># Speed up sampling!</span></a>
<a class="sourceLine" id="cb1-3" title="3"></a>
<a class="sourceLine" id="cb1-4" title="4"><span class="kw"><a href="../reference/plot.mcpfit.html">plot</a></span>(ex_ar, <span class="dt">type=</span><span class="st">"l"</span>, <span class="dt">main =</span> <span class="st">"Change point with AR(2) residuals"</span>)</a></code></pre></div>
<p><img src="arma_files/figure-html/unnamed-chunk-1-1.png" width="700"></p>
<p>We model this as a plateau (<code>1</code>) followed by a joined slope (<code>0 + time</code>) with (constant) second-order autoregressive residuals.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb2-1" title="1">segments =<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>(</a>
<a class="sourceLine" id="cb2-2" title="2">  price <span class="op">~</span><span class="st"> </span><span class="dv">1</span> <span class="op">+</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/stats/ar.html">ar</a></span>(<span class="dv">2</span>),  <span class="co"># coefficients: int_1, ar1_1, ar2_1</span></a>
<a class="sourceLine" id="cb2-3" title="3">  <span class="op">~</span><span class="st"> </span><span class="dv">0</span> <span class="op">+</span><span class="st"> </span>time  <span class="co"># time_2</span></a>
<a class="sourceLine" id="cb2-4" title="4">)</a>
<a class="sourceLine" id="cb2-5" title="5">fit =<span class="st"> </span><span class="kw"><a href="../reference/mcp.html">mcp</a></span>(segments, ex_ar)</a></code></pre></div>
<p>We can summarise the inferred coefficients and see that the naming syntax for autoregressive intercepts is <code>ar[order]_[segment]</code>. For example, <code>ar1_1</code> is the first-order autoregressive coefficient in segment 1. For slopes it will be <code>ar[order]_[normal mcp name]</code>. The first- and second-order AR coefficients were simulated to be 0.5 and 0.3 respectively in the <code>ex_ar</code> dataset, and these values are well recovered:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb3-1" title="1"><span class="kw"><a href="../reference/summary.mcpfit.html">summary</a></span>(fit)</a></code></pre></div>
<pre><code>## Family: gaussian(link = 'identity')
## Iterations: 9000 from 3 chains.
## Segments:
##   1: price ~ 1 + ar(2)
##   2: price ~ 1 ~ 0 + time
## 
## Population-level parameters:
##     name    mean   lower   upper Rhat n.eff    ts_se
##    ar1_1   0.460   0.351   0.578    1  2374   0.0123
##    ar2_1   0.253   0.143   0.369    1  2661   0.0119
##     cp_1 171.782 157.569 186.456    1   743 688.9403
##    int_1  18.144  15.604  20.517    1  2565   5.5006
##  sigma_1   4.672   4.317   5.063    1  5188   0.0582
##   time_2   0.463   0.384   0.541    1   753   0.0164</code></pre>
<p>Notice that <code>sigma</code> in AR models describe <em>innovations</em>, i.e., the part of the residuals that are not explained by the autoregressive coefficients. As always, it is good to assess posteriors and convergence more directly:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb5-1" title="1"><span class="kw"><a href="../reference/plot_pars.html">plot_pars</a></span>(fit)</a></code></pre></div>
<p><img src="arma_files/figure-html/unnamed-chunk-4-1.png" width="768"></p>
<p>Sometimes, the trace plot shows that the change point (<code>cp_1</code>) is not well identified with this model and data. As discussed in the article on <a href="../articles/tips.html">tips, tricks, and debugging</a>, you could combine a more informative prior with more samples (<code><a href="../reference/mcp.html">mcp(..., iter = 10000)</a></code>), if this is a problem.</p>
<p>You can do hypothesis testing and model comparisons with autoregressive models, just as with any other model in <code>mcp</code>. <a href="../articles/comparison.html">Read more here</a> or scroll down for an applied example.</p>
</div>
<div id="extended-use" class="section level1">
<h1 class="hasAnchor">
<a href="#extended-use" class="anchor"></a>Extended use</h1>
<p>You can combine <code>ar</code> with any regression model and with <a href="../articles/varying.html">varying change points</a>. The autoregressive modeling applies to the <em>residuals</em> from the predicted fit as is common. These residuals are computed on a transformed scale for families with a non-identity link function (e.g., <code><a href="https://rdrr.io/r/stats/family.html">poisson(link = "log")</a></code>). In time-series jargon, this is a dynamical regression model where the the “normal” regression parameters make up the <em>deterministic</em> structure. See further comments in the section on priors below.</p>
<p>Here is a varying slope change point with AR(1) residuals in both segments (it is carried over):</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb6-1" title="1">segments =<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>(</a>
<a class="sourceLine" id="cb6-2" title="2">  y <span class="op">~</span><span class="st"> </span><span class="dv">1</span> <span class="op">+</span><span class="st"> </span>x <span class="op">+</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/stats/ar.html">ar</a></span>(<span class="dv">1</span>),</a>
<a class="sourceLine" id="cb6-3" title="3">  <span class="dv">1</span> <span class="op">+</span><span class="st"> </span>(<span class="dv">1</span><span class="op">|</span>id) <span class="op">~</span><span class="st"> </span><span class="dv">0</span> <span class="op">+</span><span class="st"> </span>x <span class="op">+</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/AsIs.html">I</a></span>(x<span class="op">^</span><span class="dv">2</span>)</a>
<a class="sourceLine" id="cb6-4" title="4">)</a></code></pre></div>
<p>While the typical usage is <code>AR(N)</code>, you can also specify how autocorrelation <em>itself</em> changes with <span class="math inline">\(x\)</span> using <code><a href="https://rdrr.io/r/stats/ar.html">ar(N, formula)</a></code>. If you want to model a steady change in the AR(1) “strength”, you can do <code><a href="https://rdrr.io/r/stats/ar.html">ar(1, 1 + time)</a></code>. If you want to control the <em>direction</em> of the change, you simply put a positive-only prior the corresponding ar slope coefficient, e.g., <code>ar_x_1 = "dnorm(0, 1) T(0, )</code>. You have the full suite of <a href="../articles/formulas.html"><code>mcp</code> formula syntax</a> available inside <code>ar</code> so you could easily do <code><a href="https://rdrr.io/r/stats/ar.html">ar(3, rel(1) + I(x^2) + exp(x))</a></code>. Make sure to use a positive-only prior (e.g., <code>"dunif(0, 1)"</code> if using <code><a href="https://rdrr.io/r/base/Log.html">log()</a></code> and <code><a href="https://rdrr.io/r/base/MathFun.html">sqrt()</a></code> since they fail for negative values.</p>
<p>The regression on the AR coefficients is applied to all orders. Raise an issue on GitHub if you see a use case for per-order control.</p>
</div>
<div id="simulating-autocorrelated-change-point-data" class="section level1">
<h1 class="hasAnchor">
<a href="#simulating-autocorrelated-change-point-data" class="anchor"></a>Simulating autocorrelated change point data</h1>
<p>One side-effect of the <code>mcp</code> implementation of autocorrelation <em>in the formulas</em> is that you can infer when autocorrelation coefficients change.</p>
<p>Let’s simulate a change point in autocorrelation and see if we can infer it later. With <code>mcp</code> v0.2, you can simulate data by letting <code>mcp</code> generate the fitted predictions (dashed line below) and then add autocorrelated residuals generated by <code><a href="https://rdrr.io/r/stats/arima.sim.html">arima.sim()</a></code>:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb7-1" title="1"><span class="co"># The model</span></a>
<a class="sourceLine" id="cb7-2" title="2">segments =<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>(</a>
<a class="sourceLine" id="cb7-3" title="3">  y <span class="op">~</span><span class="st"> </span><span class="dv">1</span> <span class="op">+</span><span class="st"> </span>x <span class="op">+</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/stats/ar.html">ar</a></span>(<span class="dv">1</span>),  <span class="co"># Slope</span></a>
<a class="sourceLine" id="cb7-4" title="4">  <span class="op">~</span><span class="st"> </span><span class="dv">0</span> <span class="op">+</span><span class="st"> </span>x <span class="op">+</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/stats/ar.html">ar</a></span>(<span class="dv">1</span>)  <span class="co"># Slope and relative increase</span></a>
<a class="sourceLine" id="cb7-5" title="5">)</a>
<a class="sourceLine" id="cb7-6" title="6"></a>
<a class="sourceLine" id="cb7-7" title="7"><span class="co"># Get fitted predictions</span></a>
<a class="sourceLine" id="cb7-8" title="8">empty =<span class="st"> </span><span class="kw"><a href="../reference/mcp.html">mcp</a></span>(segments, <span class="dt">sample =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb7-9" title="9">data =<span class="st"> </span>tibble<span class="op">::</span><span class="kw"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span>(</a>
<a class="sourceLine" id="cb7-10" title="10">  <span class="dt">x =</span> <span class="kw"><a href="https://rdrr.io/r/base/seq.html">seq</a></span>(<span class="dv">0</span>, <span class="dv">100</span>, <span class="dt">length.out =</span> <span class="dv">500</span>),</a>
<a class="sourceLine" id="cb7-11" title="11">  <span class="dt">y =</span> empty<span class="op">$</span><span class="kw"><a href="https://rdrr.io/r/stats/simulate.html">simulate</a></span>(x, <span class="dt">cp_1 =</span> <span class="dv">40</span>,</a>
<a class="sourceLine" id="cb7-12" title="12">                   <span class="dt">int_1 =</span> <span class="dv">20</span>, <span class="dt">x_1 =</span> <span class="dv">1</span>, <span class="dt">x_2 =</span> <span class="dv">1</span>,  <span class="co"># same slope</span></a>
<a class="sourceLine" id="cb7-13" title="13">                   <span class="dt">sigma_1 =</span> <span class="ot">NA</span>, <span class="dt">type =</span> <span class="st">"fitted"</span>)</a>
<a class="sourceLine" id="cb7-14" title="14">)</a>
<a class="sourceLine" id="cb7-15" title="15"></a>
<a class="sourceLine" id="cb7-16" title="16"><span class="kw"><a href="../reference/plot.mcpfit.html">plot</a></span>(data, <span class="dt">type =</span><span class="st">"l"</span>, <span class="dt">lty=</span><span class="dv">2</span>, <span class="dt">main =</span> <span class="st">"Autocorrelation change point"</span>)</a>
<a class="sourceLine" id="cb7-17" title="17"></a>
<a class="sourceLine" id="cb7-18" title="18"><span class="co"># Add AR(1) residuals</span></a>
<a class="sourceLine" id="cb7-19" title="19"><span class="kw"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span>(<span class="dv">42</span>)</a>
<a class="sourceLine" id="cb7-20" title="20">ar_<span class="dv">1</span> =<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/stats/arima.sim.html">arima.sim</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="dt">ar =</span> <span class="fl">0.2</span>), <span class="dt">n =</span> <span class="dv">200</span>, <span class="dt">sd =</span> <span class="dv">7</span>)  <span class="co"># Weak AR first</span></a>
<a class="sourceLine" id="cb7-21" title="21">ar_<span class="dv">2</span> =<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/stats/arima.sim.html">arima.sim</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="dt">ar =</span> <span class="fl">0.8</span>), <span class="dt">n =</span> <span class="dv">300</span>, <span class="dt">sd =</span> <span class="dv">7</span>)  <span class="co"># Then stronger AR</span></a>
<a class="sourceLine" id="cb7-22" title="22">data<span class="op">$</span>y =<span class="st"> </span>data<span class="op">$</span>y <span class="op">+</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(ar_<span class="dv">1</span>, ar_<span class="dv">2</span>)</a>
<a class="sourceLine" id="cb7-23" title="23"></a>
<a class="sourceLine" id="cb7-24" title="24"><span class="co"># Plot it</span></a>
<a class="sourceLine" id="cb7-25" title="25"><span class="kw"><a href="https://rdrr.io/r/graphics/lines.html">lines</a></span>(data, <span class="dt">type =</span> <span class="st">"l"</span>)</a>
<a class="sourceLine" id="cb7-26" title="26"><span class="kw"><a href="https://rdrr.io/r/graphics/abline.html">abline</a></span>(<span class="dt">v =</span> <span class="dv">40</span>)</a></code></pre></div>
<p><img src="arma_files/figure-html/unnamed-chunk-6-1.png" width="700"></p>
<p>… and we use a prior to equate the slopes of each segment (read more about <a href="../articles/priors.html">using priors</a> to equate parameters and define constants). Now let’s see if we can recover these parameters.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb8-1" title="1">prior =<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="dt">x_2 =</span> <span class="st">"x_1"</span>)  <span class="co"># Set the two slopes equal</span></a>
<a class="sourceLine" id="cb8-2" title="2">fit =<span class="st"> </span><span class="kw"><a href="../reference/mcp.html">mcp</a></span>(segments, data, prior, <span class="dt">iter =</span> <span class="dv">6000</span>)</a>
<a class="sourceLine" id="cb8-3" title="3"></a>
<a class="sourceLine" id="cb8-4" title="4"><span class="co"># Show results</span></a>
<a class="sourceLine" id="cb8-5" title="5"><span class="kw"><a href="../reference/summary.mcpfit.html">summary</a></span>(fit)</a></code></pre></div>
<p>Let’s see the results:</p>
<pre><code>## Family: gaussian(link = 'identity')
## Iterations: 18000 from 3 chains.
## Segments:
##   1: y ~ 1 + x + ar(1)
##   2: y ~ 1 ~ 0 + x + ar(1)
## 
## Population-level parameters:
##     name   mean   lower  upper Rhat n.eff    ts_se
##    ar1_1  0.216  0.0633  0.388 1.00   289 3.88e-01
##    ar1_2  0.795  0.7227  0.871 1.00  2125 8.16e-03
##     cp_1 42.530 38.0843 55.685 1.01    58 5.15e+03
##    int_1 19.984 18.0916 22.084 1.00  2403 7.63e+00
##  sigma_1  7.040  6.5909  7.478 1.00  8173 8.98e-02
##      x_1  0.987  0.9247  1.053 1.00  1631 8.56e-03
##      x_2  0.987  0.9247  1.053 1.00  1631 8.56e-03</code></pre>
<p>We see that all parameters are well recovered. However, there is a dangerously low effective sample size for the change point (<code>cp_1</code>), indicating a potential problem. We can inspect this further using trace plots and posterior distributions. As is often the case, we see that the change point posterior is not well described by parameterized distribution. In this case, the change point posterior is a bit bimodal with some credence to a change point around 55 too. This is understandable if you look at the data.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb10-1" title="1"><span class="kw"><a href="../reference/plot_pars.html">plot_pars</a></span>(fit, <span class="dt">regex_pars =</span> <span class="st">"cp_1|ar_*"</span>)</a></code></pre></div>
<p><img src="arma_files/figure-html/unnamed-chunk-9-1.png" width="700"></p>
<p>As usual, we can test hypotheses and do model comparison (<a href="../articles/comparison.html">read more here</a>). For example, what is the evidence that <code>ar1_2</code> is more than 0.4 greater than <code>ar1_1</code>? Answer: It is quite compelling</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb11-1" title="1"><span class="kw"><a href="../reference/hypothesis.html">hypothesis</a></span>(fit, <span class="st">"ar1_1 + 0.4 &lt; ar1_2"</span>)</a></code></pre></div>
<pre><code>##                hypothesis       mean      lower      upper         p       BF
## 1 ar1_1 + 0.4 - ar1_2 &lt; 0 -0.1788844 -0.3445744 -0.0103212 0.9793889 47.51752</code></pre>
<p>Or how does this compare to a model with just the slope and no autocorrelation? Answer: quite strong with an <code>elpd_diff/se_diff</code> factor of around 6.</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb13-1" title="1">fit_null =<span class="st"> </span><span class="kw"><a href="../reference/mcp.html">mcp</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>(y <span class="op">~</span><span class="st"> </span><span class="dv">1</span> <span class="op">+</span><span class="st"> </span>x), data)</a>
<a class="sourceLine" id="cb13-2" title="2">fit<span class="op">$</span>loo =<span class="st"> </span><span class="kw"><a href="../reference/criterion.html">loo</a></span>(fit)</a>
<a class="sourceLine" id="cb13-3" title="3">fit_null<span class="op">$</span>loo =<span class="st"> </span><span class="kw"><a href="../reference/criterion.html">loo</a></span>(fit_null)</a>
<a class="sourceLine" id="cb13-4" title="4"></a>
<a class="sourceLine" id="cb13-5" title="5">loo<span class="op">::</span><span class="kw"><a href="https://mc-stan.org/loo/reference/loo_compare.html">loo_compare</a></span>(fit<span class="op">$</span>loo, fit_null<span class="op">$</span>loo)</a></code></pre></div>
<pre><code>##        elpd_diff se_diff
## model1    0.0       0.0 
## model2 -165.2      16.6</code></pre>
</div>
<div id="priors-on-autoregressive-coefficients" class="section level1">
<h1 class="hasAnchor">
<a href="#priors-on-autoregressive-coefficients" class="anchor"></a>Priors on autoregressive coefficients</h1>
<p>The default prior on autoregressive intercepts is a <code><a href="https://rdrr.io/r/stats/Uniform.html">dunif(-1, 1)</a></code> to ensure a stationary series while being otherwise agnostic about the magnitude and direction of the autocorrelation. For most time series, you would expect a positive first-order autocorrelation, e.g., <code>ar1_1 = "dunif(0, 1)"</code> or even something like <code>ar1_1 = "dnorm(0.5, 0.5) T(0, 1)"</code>. <a href="../articles/priors.html">Read more about priors</a>. Similarly, you would expect a smaller-but-still-positive second-order autocorrelation, e.g., <code>ar2_1 = dunif(0, ar1_1)</code>.</p>
<p>Here is a complete list of the (default) priors in the model above:</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb15-1" title="1"><span class="kw"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span>(fit<span class="op">$</span>prior)</a></code></pre></div>
<pre><code>##         [,1]                           
## cp_1    "dunif(MINX, MAXX)"            
## int_1   "dt(0, 3 * SDY, 3)"            
## x_1     "dt(0, SDY / (MAXX - MINX), 3)"
## x_2     "x_1"                          
## sigma_1 "dnorm(0, SDY) T(0, )"         
## ar1_1   "dunif(-1, 1)"                 
## ar1_2   "dunif(-1, 1)"</code></pre>
<p>Let’s inspect the priors for a more advanced AR model, since you would often have to inform these:</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb17-1" title="1">segments =<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>(</a>
<a class="sourceLine" id="cb17-2" title="2">  y <span class="op">~</span><span class="st"> </span><span class="dv">1</span> <span class="op">+</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/stats/ar.html">ar</a></span>(<span class="dv">2</span>, <span class="dv">1</span> <span class="op">+</span><span class="st"> </span>x),</a>
<a class="sourceLine" id="cb17-3" title="3">  <span class="op">~</span><span class="st"> </span><span class="dv">0</span> <span class="op">+</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/stats/ar.html">ar</a></span>(<span class="dv">1</span>, <span class="kw">rel</span>(<span class="dv">1</span>) <span class="op">+</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/AsIs.html">I</a></span>(x<span class="op">^</span><span class="dv">2</span>))</a>
<a class="sourceLine" id="cb17-4" title="4">)</a>
<a class="sourceLine" id="cb17-5" title="5">empty =<span class="st"> </span><span class="kw"><a href="../reference/mcp.html">mcp</a></span>(segments, <span class="dt">sample =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb17-6" title="6"><span class="kw"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span>(empty<span class="op">$</span>prior)</a></code></pre></div>
<pre><code>##            [,1]                         
## cp_1       "dunif(MINX, MAXX)"          
## int_1      "dt(0, 3 * SDY, 3)"          
## sigma_1    "dnorm(0, SDY) T(0, )"       
## ar1_1      "dunif(-1, 1)"               
## ar2_1      "dunif(-1, 1)"               
## ar1_x_1    "dnorm(0, 1 / (MAXX - MINX))"
## ar2_x_1    "dnorm(0, 1 / (MAXX - MINX))"
## ar1_2      "dunif(-1, 1)"               
## ar1_x_2_E2 "dnorm(0, 1 / (MAXX - MINX))"</code></pre>
<p>As with <code>sigma</code>, the link function for the autoregressive coefficient itself is <code>"identity"</code> though the autoregressive coefficient is computed from residuals using the link function provided in <code><a href="../reference/mcp.html">mcp(..., family = func(link = "something"))</a></code>. Because stationarity is important, careful consideration of the allowed and probable values (the prior) is necessary when going beyond simple absolute intercepts to avoid <code>ar</code> values outside [-1, 1].</p>
<p>Here are a few ways in which you may want to inform the <code>ar</code> parameters in the model above:</p>
<ul>
<li>As mentioned above, you may want to constrain second-order autocorrelations to <code>ar2_1 ~ dunif(0, ar1_1)</code>.</li>
<li>The relative change in intercept in the second segment (<code>ar1_2</code>) can at most be -1 with the default prior. If <code>ar1_1</code> was 0.8, this means that it can at most change to -0.2 in the next segment. Use <code>rel()</code> with care.</li>
<li>Slopes can quickly make the parameter exceed the -1 and 1 boundaries, inducing non-stationarity. You would often want to constrain their magnitude to small slopes, taking into consideration the expected span of the x-axis over which this slope runs. The default prior on <code>ar</code>-slopes is a 68% change that there is a change of 1 from the first to the last observation (<code>"dnorm(0, 1 / (MAXX - MINX))"</code>) and you may want to, for example, suggest a shallow negative slope using <code>"dnorm(0, 0.1 / (MAXX-MINX)) T( , 0)"</code>
</li>
</ul>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">

        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#simple-example">Simple example</a></li>
      <li><a href="#extended-use">Extended use</a></li>
      <li><a href="#simulating-autocorrelated-change-point-data">Simulating autocorrelated change point data</a></li>
      <li><a href="#priors-on-autoregressive-coefficients">Priors on autoregressive coefficients</a></li>
      </ul>
</div>
      </div>

</div>



      <footer><div class="copyright">
  <p>Developed by <a href="http://lindeloev.net">Jonas Kristoffer Lindeløv</a>.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.4.1.</p>
</div>

      </footer>
</div>

  
<script src="https://cdnjs.cloudflare.com/ajax/libs/docsearch.js/2.6.1/docsearch.min.js" integrity="sha256-GKvGqXDznoRYHCwKXGnuchvKSwmx9SRMrZOTh2g4Sb0=" crossorigin="anonymous"></script><script>
  docsearch({
    
    
    apiKey: '702ab134d40a7310606c29f341fc5014',
    indexName: 'lindeloev_mcp',
    inputSelector: 'input#search-input.form-control',
    transformData: function(hits) {
      return hits.map(function (hit) {
        hit.url = updateHitURL(hit);
        return hit;
      });
    }
  });
</script>
</body>
</html>
